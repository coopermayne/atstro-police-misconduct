---
/**
 * MetadataItem Component
 * Single flexible metadata component that displays different types of information
 * Type determines icon, styling, and formatting
 */

interface Props {
  type: 'date' | 'location' | 'age' | 'bodycam' | 'agency' | 'forceType' | 'tag' | 'investigationStatus';
  content?: string | number | boolean | null | undefined | string[] | { city: string; county?: string };
  variant?: 'inline' | 'badge';
  size?: 'sm' | 'md' | 'lg';
  shortname?: boolean;
}

const { 
  type, 
  content, 
  variant = type === 'agency' || type === 'forceType' || type === 'tag' || type === 'investigationStatus' ? 'badge' : 'inline',
  size = 'md',
  shortname = false
} = Astro.props;

// Import utility function for shortname lookup (assumes this will be created)
import { getShortName } from '../utils/display-names';

const sizeConfig = {
  sm: { text: 'text-xs', icon: 'w-3 h-3', gap: 'gap-1', badge: 'px-2 py-1 text-xs' },
  md: { text: 'text-sm', icon: 'w-4 h-4', gap: 'gap-1.5', badge: 'px-3 py-1 text-xs' },
  lg: { text: 'text-base', icon: 'w-5 h-5', gap: 'gap-2', badge: 'px-3 py-1.5 text-sm' }
};

const config = sizeConfig[size];

// Handle array content (for agencies, forceTypes, tags)
const isArrayType = Array.isArray(content);
const items = isArrayType ? content.filter(Boolean) : [];

// Apply shortname transformation if requested
const processedItems = shortname && isArrayType 
  ? items.map(item => getShortName(String(item))) 
  : items;

// Extract location data if content is an object
const locationData = type === 'location' && typeof content === 'object' && content !== null && !Array.isArray(content)
  ? content as { city: string; county?: string }
  : null;

// Format content based on type
function formatContent(type: string, content: string | number | boolean, size: string): string {
  if (type === 'date' && typeof content === 'string') {
    try {
      const date = new Date(content);
      if (isNaN(date.getTime())) return String(content);
      if (size === 'sm') {
        return date.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });
      }
      return date.toLocaleDateString('en-US', { year: 'numeric', month: 'long', day: 'numeric' });
    } catch {
      return String(content);
    }
  }
  if (type === 'age' && (typeof content === 'number' || typeof content === 'string')) {
    return `Age ${content}`;
  }
  if (type === 'bodycam') {
    return 'Body Cam';
  }
  return String(content);
}

// Format location from object
function formatLocation(locationData: { city: string; county?: string } | null): string {
  if (!locationData?.city) return '';
  return `${locationData.city}, ${locationData.county ? `${locationData.county} County` : 'CA'}`;
}

// Determine if component should render
const shouldRender = isArrayType
  ? processedItems.length > 0
  : type === 'bodycam' 
    ? content === true 
    : type === 'location'
      ? !!locationData?.city
      : content !== null && content !== undefined && content !== '';

// Calculate display text
const displayText = !isArrayType 
  ? type === 'location' 
    ? formatLocation(locationData)
    : content && typeof content !== 'object'
      ? shortname 
        ? getShortName(formatContent(type, content as string | number | boolean, size))
        : formatContent(type, content as string | number | boolean, size)
      : ''
  : '';

// Icon SVGs
const icons = {
  date: '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z" />',
  location: '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z" /><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z" />',
  age: '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z" />',
  bodycam: '<path d="M23 7l-7 5 7 5V7z"/><rect x="1" y="5" width="15" height="14" rx="2" ry="2"/>',
  agency: '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4" />',
  forceType: '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" />',
  tag: '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 7h.01M7 3h5c.512 0 1.024.195 1.414.586l7 7a2 2 0 010 2.828l-7 7a2 2 0 01-2.828 0l-7-7A1.994 1.994 0 013 12V7a4 4 0 014-4z" />',
  investigationStatus: '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-6 9l2 2 4-4" />'
};

// Color schemes
const colors = {
  date: 'text-gray-600 dark:text-gray-400',
  location: 'text-gray-600 dark:text-gray-400',
  age: 'text-gray-600 dark:text-gray-400',
  bodycam: variant === 'inline' 
    ? 'text-green-600 dark:text-green-500 font-medium' 
    : 'bg-green-50 dark:bg-green-900/20 text-green-700 dark:text-green-400 border-green-200 dark:border-green-800/50',
  agency: 'bg-gray-100 dark:bg-gray-700/50 text-gray-700 dark:text-gray-300 border-gray-300 dark:border-gray-600',
  forceType: 'bg-orange-50 dark:bg-orange-900/20 text-orange-800 dark:text-orange-300 border-orange-200 dark:border-orange-800/50',
  tag: 'bg-gray-100 dark:bg-gray-700/50 text-gray-700 dark:text-gray-300 border-gray-300 dark:border-gray-600',
  investigationStatus: 'bg-blue-50 dark:bg-blue-900/20 text-blue-800 dark:text-blue-300 border-blue-200 dark:border-blue-800/50'
};

const iconColor = type === 'bodycam' && variant === 'inline' ? '' : 'text-gray-400 dark:text-gray-500';
---

{shouldRender && !isArrayType && variant === 'inline' && (
  <div class={`flex items-center ${config.gap} ${config.text} ${colors[type]}`}>
    <svg class={`${config.icon} ${iconColor}`} fill="none" stroke="currentColor" viewBox="0 0 24 24" set:html={icons[type]} />
    <span>{displayText}</span>
  </div>
)}

{shouldRender && !isArrayType && variant === 'badge' && (
  <span class={`inline-flex items-center ${config.gap} ${config.badge} ${colors[type]} rounded border`}>
    <svg class={`${config.icon} ${iconColor}`} fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" set:html={icons[type]} />
    {displayText}
  </span>
)}

{shouldRender && isArrayType && processedItems.map(item => (
  <span class={`inline-flex items-center ${config.gap} ${config.badge} ${colors[type]} rounded border`}>
    <svg class={`${config.icon} ${iconColor}`} fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" set:html={icons[type]} />
    {String(item)}
  </span>
))}
