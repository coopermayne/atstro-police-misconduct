---
/**
 * Related Cases Component
 * Shows related cases based on relationships
 */
import { getCollection } from 'astro:content';
import CaseCard from './CaseCard.astro';

interface Props {
  currentSlug: string;
  relatedCaseSlugs?: string[];
  agency?: string;
  forceType?: string[];
  county?: string;
  tags?: string[];
  maxResults?: number;
}

const {
  currentSlug,
  relatedCaseSlugs = [],
  agency,
  forceType = [],
  county,
  tags = [],
  maxResults = 3
} = Astro.props;

// Get all published cases
const allCases = await getCollection('cases', ({ data }) => data.published);

// Start with explicitly related cases
let relatedCases = relatedCaseSlugs.length > 0
  ? allCases.filter(c => relatedCaseSlugs.includes(c.slug) && c.slug !== currentSlug)
  : [];

// If we need more, find cases by similarity
if (relatedCases.length < maxResults) {
  const similarCases = allCases
    .filter(c => {
      if (c.slug === currentSlug) return false;
      if (relatedCaseSlugs.includes(c.slug)) return false; // Already included

      // Score by similarity
      let score = 0;

      // Same agency (highest priority)
      if (agency && c.data.agencies?.includes(agency)) score += 3;

      // Same force type
      if (forceType.length > 0 && c.data.force_type) {
        const overlap = forceType.filter(ft => c.data.force_type?.includes(ft));
        score += overlap.length * 2;
      }

      // Same county
      if (county && c.data.county === county) score += 1;

      // Shared tags
      if (tags.length > 0 && c.data.tags) {
        const sharedTags = tags.filter(t => c.data.tags?.includes(t));
        score += sharedTags.length;
      }

      return score > 0;
    })
    .sort((a, b) => {
      // Sort by score (recalculate)
      let scoreA = 0, scoreB = 0;

      if (agency) {
        if (a.data.agencies?.includes(agency)) scoreA += 3;
        if (b.data.agencies?.includes(agency)) scoreB += 3;
      }

      if (forceType.length > 0) {
        const overlapA = forceType.filter(ft => a.data.force_type?.includes(ft));
        const overlapB = forceType.filter(ft => b.data.force_type?.includes(ft));
        scoreA += overlapA.length * 2;
        scoreB += overlapB.length * 2;
      }

      if (county) {
        if (a.data.county === county) scoreA += 1;
        if (b.data.county === county) scoreB += 1;
      }

      if (tags.length > 0) {
        const sharedTagsA = tags.filter(t => a.data.tags?.includes(t));
        const sharedTagsB = tags.filter(t => b.data.tags?.includes(t));
        scoreA += sharedTagsA.length;
        scoreB += sharedTagsB.length;
      }

      return scoreB - scoreA;
    })
    .slice(0, maxResults - relatedCases.length);

  relatedCases = [...relatedCases, ...similarCases];
}

// Limit to maxResults (default 3)
relatedCases = relatedCases.slice(0, maxResults);
---

{relatedCases.length >= 3 && (
  <section class="mt-12 pt-8 border-t border-gray-200 dark:border-gray-700">
    <h2 class="text-2xl font-bold text-gray-800 dark:text-white mb-6">Related Cases</h2>
    <div class="grid md:grid-cols-3 gap-6">
      {relatedCases.slice(0, 3).map(relatedCase => (
        <CaseCard case={relatedCase} showImage={true} showDescription={true} showReadMore={true} />
      ))}
    </div>
  </section>
)}
