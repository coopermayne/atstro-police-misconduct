---
import MainLayout from '../../layouts/MainLayout.astro';
import DocumentsList from '../../components/DocumentsList.astro';
import ExternalLinkCard from '../../components/ExternalLinkCard.astro';
import RelatedCases from '../../components/RelatedCases.astro';
import MetadataItem from '../../components/MetadataItem.astro';
import { getCollection } from 'astro:content';

// Helper function to create slug from text
function createSlug(name: string): string {
  return name.toLowerCase().trim().replace(/\s+/g, '-');
}

export async function getStaticPaths() {
  const cases = await getCollection('cases');
  return cases.map(caseItem => ({
    params: { slug: caseItem.slug },
    props: { caseItem },
  }));
}

const { caseItem } = Astro.props;
const { Content } = await caseItem.render();

// SEO data
const siteUrl = 'https://www.californiapolicemisconduct.com';
const canonicalUrl = `${siteUrl}/cases/${caseItem.slug}`;
const ogImage = caseItem.data.featured_image?.url || `${siteUrl}/images/og-default.jpg`;

// JSON-LD structured data
const jsonLd = {
  "@context": "https://schema.org",
  "@type": "NewsArticle",
  "headline": caseItem.data.title,
  "description": caseItem.data.description,
  "image": ogImage,
  "datePublished": caseItem.data.incident_date,
  "dateModified": caseItem.data.last_updated || caseItem.data.incident_date,
  "author": {
    "@type": "Organization",
    "name": "California Police Misconduct"
  },
  "publisher": {
    "@type": "Organization",
    "name": "California Police Misconduct",
    "url": siteUrl
  },
  "mainEntityOfPage": {
    "@type": "WebPage",
    "@id": canonicalUrl
  },
  "about": {
    "@type": "Event",
    "name": caseItem.data.title,
    "startDate": caseItem.data.incident_date,
    "location": {
      "@type": "Place",
      "address": {
        "@type": "PostalAddress",
        "addressLocality": caseItem.data.city,
        "addressRegion": caseItem.data.county,
        "addressCountry": "US"
      }
    }
  }
};
---

<MainLayout content={{
  title: caseItem.data.title,
  description: caseItem.data.description,
  image: ogImage,
  type: 'article',
  publishedDate: caseItem.data.incident_date
}}>
  <script type="application/ld+json" set:html={JSON.stringify(jsonLd)} />
  <article class="py-8" data-pagefind-body>
    <!-- Breadcrumb / Back Navigation -->
    <nav class="mb-6 px-6">
      <a 
        href="/cases"
        class="inline-flex items-center text-sm text-gray-600 dark:text-gray-400 hover:text-red-600 dark:hover:text-red-400 transition-colors"
      >
        ‚Üê Back to all cases
      </a>
    </nav>

    <!-- Case Header and Content -->
    <div class="bg-white dark:bg-gray-800 rounded-none md:rounded-lg shadow-md border-x-0 md:border-x border-y md:border border-gray-200 dark:border-gray-700 p-8 mb-8">
      <!-- Basic Info Above Title (Date, Location, Age only) -->
      <div class="flex flex-wrap gap-x-4 gap-y-2 mb-4">
        <MetadataItem type="date" content={caseItem.data.incident_date} size="md" />
        <MetadataItem type="location" content={{ city: caseItem.data.city, county: caseItem.data.county }} size="md" />
        <MetadataItem type="age" content={caseItem.data.age} size="md" />
      </div>
      
      <h1 class="text-3xl lg:text-4xl font-semibold text-gray-800 dark:text-white mb-4 border-b-4 border-red-600 pb-4 flex justify-between items-center" data-pagefind-weight="10">
        <span>{caseItem.data.title}</span>
        <MetadataItem type="bodycam" content={caseItem.data.bodycam_available} size="md" variant="badge" />
      </h1>

      <p class="text-lg text-gray-500 dark:text-gray-400 italic mb-6">
        {caseItem.data.description}
      </p>

      <!-- Additional Metadata (Agencies, Force Type, Video) -->
      <div class="flex flex-wrap gap-2 mb-8">
        <MetadataItem type="agency" content={caseItem.data.agencies} size="md" />
        <MetadataItem type="forceType" content={caseItem.data.force_type} size="md" />
        <MetadataItem type="investigationStatus" content={caseItem.data.investigation_status} size="md" />
      </div>

        <!-- Case Content -->
        <div class="prose prose-lg prose-gray dark:prose-invert max-w-none">
          <Content />
        </div>

        <!-- Documents Section -->
        {caseItem.data.documents && caseItem.data.documents.length > 0 && (
          <div class="mt-8">
            <DocumentsList documents={caseItem.data.documents} />
          </div>
        )}
        
        <!-- External Links Section -->
        {caseItem.data.external_links && caseItem.data.external_links.length > 0 && (
          <div class="mt-8">
            <h2 class="text-2xl font-bold text-gray-800 dark:text-white mb-4">External Coverage & Resources</h2>
            {caseItem.data.external_links.map(link => (
              <ExternalLinkCard
                url={link.url}
                title={link.title}
                description={link.description}
                icon={link.icon || 'generic'}
              />
            ))}
          </div>
        )}

    </div>

    <!-- Related Cases -->
    <div class="px-6">
      <RelatedCases
        currentSlug={caseItem.slug}
        relatedCaseSlugs={caseItem.data.related_cases || []}
        agency={caseItem.data.agencies?.[0]}
        forceType={caseItem.data.force_type}
        county={caseItem.data.county}
        maxResults={4}
      />
    </div>
  </article>
</MainLayout>