---
import MainLayout from '../../layouts/MainLayout.astro';
import { getCollection } from 'astro:content';

// Get all published cases
const cases = await getCollection('cases', ({ data }) => data.published);

// Sort by incident date (most recent first)
const sortedCases = cases.sort((a, b) => 
  new Date(b.data.incident_date).getTime() - new Date(a.data.incident_date).getTime()
);

// Get unique values for filters
const counties = [...new Set(cases.map(c => c.data.county))].sort();
const agencies = [...new Set(cases.flatMap(c => c.data.agencies))].sort();
const threatLevels = ['No threat', 'Low', 'Moderate', 'High', 'Deadly'];
const forceTypes = ['Shooting', 'Beating', 'Taser', 'Restraint', 'Chokehold', 'Other'];

// Get the most recent case for featured section
const featuredCase = sortedCases[0];
const recentCases = sortedCases.slice(1, 4);

// Helper to get featured image URL
function getFeaturedImageUrl(imageId: string | undefined): string | undefined {
  if (!imageId) return undefined;
  const accountHash = "3oZsG34qPq3SIXQhl47vqA";
  return `https://imagedelivery.net/${accountHash}/${imageId}/public`;
}
---

<MainLayout content={{ title: 'Cases' }}>
  <!-- Hero Section -->
  <header class="bg-white dark:bg-gray-900 mb-6">
    <div class="container px-6 py-8 mx-auto border-b-4 border-red-600">
      <h1 class="text-3xl font-semibold text-gray-800 dark:text-white lg:text-4xl">
        California <span class="text-red-600">Deadly Force Cases</span>
      </h1>
      <p class="mt-3 text-gray-600 dark:text-gray-400">
        Comprehensive documentation of deadly force incidents across California
      </p>
    </div>
  </header>

  <!-- Featured Case Section -->
  <section class="bg-white dark:bg-gray-900 px-6 py-8 mb-0 border-b border-gray-200 dark:border-gray-700">
    <div class="container mx-auto">
      <h2 class="text-3xl font-bold text-gray-800 dark:text-white mb-6">
        Recent Cases
      </h2>
      
      <div class="lg:flex lg:-mx-6">
        <!-- Most Recent Case (Featured) -->
        {featuredCase && (
          <div class="lg:w-3/4 lg:px-6">
            <a href={`/cases/${featuredCase.slug}`}>
              {featuredCase.data.featured_image ? (
                <img 
                  class="object-cover object-center w-full h-80 xl:h-[28rem] rounded-xl" 
                  src={getFeaturedImageUrl(featuredCase.data.featured_image)} 
                  alt={featuredCase.data.title}
                />
              ) : (
                <div class="bg-gray-100 dark:bg-gray-800 w-full h-80 xl:h-[28rem] rounded-xl flex flex-col items-center justify-center p-8 border-2 border-gray-300 dark:border-gray-600">
                  <h3 class="text-4xl font-bold text-gray-800 dark:text-white mb-4">{featuredCase.data.title}</h3>
                  <p class="text-xl text-gray-600 dark:text-gray-400">{featuredCase.data.city}, {featuredCase.data.county} County</p>
                  <p class="text-lg text-gray-600 dark:text-gray-400 mt-2">{new Date(featuredCase.data.incident_date).toLocaleDateString('en-US', { year: 'numeric', month: 'long', day: 'numeric' })}</p>
                </div>
              )}
            </a>
            
            <div>
              <p class="mt-4 text-sm text-red-600 uppercase">Most Recent Case</p>
              
              <!-- Name -->
              <h1 class="mt-2 text-2xl font-semibold leading-tight text-gray-800 dark:text-white">
                <a href={`/cases/${featuredCase.slug}`} class="hover:text-red-600 dark:hover:text-red-500">
                  {featuredCase.data.title}
                </a>
              </h1>
              
              <!-- Metadata with Icons -->
              <div class="flex flex-wrap gap-x-4 gap-y-2 text-sm text-gray-600 dark:text-gray-400 mt-2">
                {featuredCase.data.age && (
                  <div class="flex items-center gap-1.5">
                    <svg class="w-4 h-4 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z" />
                    </svg>
                    <span>Age {featuredCase.data.age}</span>
                  </div>
                )}
                <div class="flex items-center gap-1.5">
                  <svg class="w-4 h-4 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z" />
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z" />
                  </svg>
                  <span>{featuredCase.data.city}, {featuredCase.data.county} County</span>
                </div>
                <div class="flex items-center gap-1.5">
                  <svg class="w-4 h-4 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z" />
                  </svg>
                  <span>{new Date(featuredCase.data.incident_date).toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' })}</span>
                </div>
              </div>
              
              <!-- Agency Pills -->
              <div class="flex flex-wrap gap-2 mt-3">
                {featuredCase.data.agencies.slice(0, 3).map(agency => (
                  <span class="px-3 py-1 bg-gray-100 dark:bg-gray-700 text-gray-700 dark:text-gray-300 text-xs rounded border border-gray-300 dark:border-gray-600">
                    {agency}
                  </span>
                ))}
              </div>
              
              <!-- Description -->
              <p class="mt-3 text-gray-600 dark:text-gray-400">
                {featuredCase.data.description}
              </p>
              
              <a 
                href={`/cases/${featuredCase.slug}`} 
                class="inline-block mt-3 text-red-600 hover:underline"
              >
                Read Full Case â†’
              </a>
            </div>
          </div>
        )}

        <!-- Other Recent Cases (Sidebar) -->
        <div class="mt-8 lg:w-1/4 lg:mt-0 lg:px-6">
          {recentCases.map((caseItem, index) => (
            <div>
              <h3 class="text-red-600 capitalize text-sm">Recent Case</h3>
              <a 
                href={`/cases/${caseItem.slug}`} 
                class="block mt-2 font-medium text-gray-800 hover:underline hover:text-red-600 dark:text-white dark:hover:text-red-500"
              >
                {caseItem.data.title}
              </a>
              <div class="flex flex-wrap gap-x-4 gap-y-1 text-sm text-gray-600 dark:text-gray-400 mt-2">
                {caseItem.data.age && (
                  <div class="flex items-center gap-1">
                    <svg class="w-4 h-4 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z" />
                    </svg>
                    <span>Age {caseItem.data.age}</span>
                  </div>
                )}
                <div class="flex items-center gap-1">
                  <svg class="w-4 h-4 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z" />
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z" />
                  </svg>
                  <span>{caseItem.data.city}, {caseItem.data.county} County</span>
                </div>
                <div class="flex items-center gap-1">
                  <svg class="w-4 h-4 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z" />
                  </svg>
                  <span>{new Date(caseItem.data.incident_date).toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' })}</span>
                </div>
              </div>
              {index < recentCases.length - 1 && (
                <hr class="my-4 border-gray-200 dark:border-gray-700" />
              )}
            </div>
          ))}
        </div>
      </div>
    </div>
  </section>

  <!-- All Cases Section -->
  <section class="bg-gray-50 dark:bg-gray-800 px-6 py-8">
    <div class="container mx-auto">
      <div class="mb-6">
        <h2 class="text-3xl font-bold text-gray-800 dark:text-white mb-2">All Cases</h2>
        <p class="text-gray-600 dark:text-gray-400">Browse and filter our complete database of deadly force incidents</p>
      </div>
      <div class="flex items-center gap-4 flex-wrap">
        <!-- Search Input -->
        <div class="flex-1 min-w-[300px] relative">
          <svg class="absolute left-3 top-1/2 transform -translate-y-1/2 w-4 h-4 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
          </svg>
          <input 
            type="text" 
            id="case-search"
            placeholder="Search cases..."
            class="w-full pl-10 pr-3 py-2 text-sm text-gray-700 bg-white border border-gray-300 rounded-lg dark:bg-gray-800 dark:text-gray-300 dark:border-gray-600 focus:border-red-500 dark:focus:border-red-400 focus:outline-none transition-colors"
          />
        </div>

        <!-- Filter Buttons -->
        <div class="flex items-center gap-2">
          <button 
            id="location-filter-btn"
            class="filter-btn px-3 py-2 bg-white dark:bg-gray-800 border border-gray-300 dark:border-gray-600 rounded-lg text-xs font-medium text-gray-700 dark:text-gray-300 hover:border-red-500 dark:hover:border-red-400 transition-colors"
          >
            County
          </button>

          <button 
            id="agency-filter-btn"
            class="filter-btn px-3 py-2 bg-white dark:bg-gray-800 border border-gray-300 dark:border-gray-600 rounded-lg text-xs font-medium text-gray-700 dark:text-gray-300 hover:border-red-500 dark:hover:border-red-400 transition-colors"
          >
            Agency
          </button>

          <button 
            id="bodycam-filter-btn"
            class="filter-btn px-3 py-2 bg-white dark:bg-gray-800 border border-gray-300 dark:border-gray-600 rounded-lg text-xs font-medium text-gray-700 dark:text-gray-300 hover:border-red-500 dark:hover:border-red-400 transition-colors"
            data-toggle-filter="bodycam"
          >
            ðŸ“¹ Body Cam
          </button>
        </div>

        <!-- Result Count -->
        <p id="result-count" class="text-xs text-gray-600 dark:text-gray-400 font-medium whitespace-nowrap">
          {sortedCases.length} cases
        </p>

        <!-- Clear Filters -->
        <button 
          id="clear-filters"
          class="px-3 py-2 text-xs font-medium text-red-600 dark:text-red-400 hover:text-red-700 dark:hover:text-red-300 hidden"
        >
          Clear
        </button>
      </div>

      <!-- Active Filters Pills -->
      <div id="active-filters" class="flex flex-wrap gap-2 mt-3 mb-6 empty:hidden">
        <!-- Active filter pills will be inserted here -->
      </div>

      <!-- Filter Dropdowns (Hidden by default) -->
      <div class="relative">
    <!-- Location Filter Dropdown -->
    <div id="location-filter-dropdown" class="hidden absolute left-0 right-0 bg-white dark:bg-gray-800 shadow-lg border-t border-gray-200 dark:border-gray-700 z-20">
      <div class="container mx-auto px-6 py-6">
        <div class="max-w-md">
          <h3 class="text-sm font-semibold text-gray-800 dark:text-white mb-4">Select County</h3>
          <div class="grid grid-cols-2 gap-2 max-h-64 overflow-y-auto">
            {counties.map(county => (
              <label class="flex items-center px-3 py-2 hover:bg-gray-50 dark:hover:bg-gray-700 rounded cursor-pointer">
                <input 
                  type="radio" 
                  name="county-filter"
                  value={county}
                  class="mr-2 text-red-600 focus:ring-red-500"
                />
                <span class="text-sm text-gray-700 dark:text-gray-300">{county} County</span>
              </label>
            ))}
          </div>
        </div>
      </div>
    </div>

    <!-- Agency Filter Dropdown -->
    <div id="agency-filter-dropdown" class="hidden absolute left-0 right-0 bg-white dark:bg-gray-800 shadow-lg border-t border-gray-200 dark:border-gray-700 z-20">
      <div class="container mx-auto px-6 py-6">
        <div class="max-w-md">
          <h3 class="text-sm font-semibold text-gray-800 dark:text-white mb-4">Select Agency</h3>
          <div class="grid grid-cols-2 gap-2 max-h-64 overflow-y-auto">
            {agencies.map(agency => (
              <label class="flex items-center px-3 py-2 hover:bg-gray-50 dark:hover:bg-gray-700 rounded cursor-pointer">
                <input 
                  type="radio" 
                  name="agency-filter"
                  value={agency}
                  class="mr-2 text-red-600 focus:ring-red-500"
                />
                <span class="text-sm text-gray-700 dark:text-gray-300">{agency}</span>
              </label>
            ))}
          </div>
        </div>
      </div>
    </div>

    <!-- No Results Message -->
      <div id="no-results" style="display: none;" class="text-center py-12">
        <p class="text-lg text-gray-600 dark:text-gray-400">No cases match your search criteria.</p>
        <button 
          onclick="document.getElementById('clear-filters').click()"
          class="mt-4 px-6 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 transition-colors"
        >
          Clear Filters
        </button>
      </div>

      <div id="cases-container" class="grid gap-6 md:grid-cols-2 lg:grid-cols-3">
      {sortedCases.map(caseItem => (
        <article 
          class="bg-white dark:bg-gray-800 rounded-lg shadow-md hover:shadow-lg transition-shadow border border-gray-200 dark:border-gray-700"
          data-case={JSON.stringify({
            title: caseItem.data.title,
            city: caseItem.data.city,
            county: caseItem.data.county,
            agencies: caseItem.data.agencies,
            incident_date: caseItem.data.incident_date,
            case_id: caseItem.data.case_id,
            armed_status: caseItem.data.armed_status,
            cause_of_death: caseItem.data.cause_of_death,
            threat_level: caseItem.data.threat_level,
            force_type: caseItem.data.force_type,
            shooting_officers: caseItem.data.shooting_officers,
            bodycam_available: caseItem.data.bodycam_available
          })}
        >
          <div class="p-6">
            <h2 class="text-xl font-semibold text-gray-800 dark:text-white mb-3">
              <a href={`/cases/${caseItem.slug}`} class="hover:text-red-600 dark:hover:text-red-500">
                {caseItem.data.title}
              </a>
            </h2>
            
            <p class="text-sm text-gray-600 dark:text-gray-400 mb-4">
              {caseItem.data.description}
            </p>

            <p class="text-xs text-gray-500 dark:text-gray-500 mb-4">
              {new Date(caseItem.data.incident_date).toLocaleDateString('en-US', { year: 'numeric', month: 'long', day: 'numeric' })}
            </p>

            <div class="flex flex-wrap gap-2 mb-4">
              {caseItem.data.agencies.map(agency => (
                <span class="px-2 py-1 bg-gray-100 dark:bg-gray-700 text-gray-700 dark:text-gray-300 text-xs rounded border border-gray-300 dark:border-gray-600">
                  {agency}
                </span>
              ))}
              {caseItem.data.bodycam_available && (
                <span class="px-2 py-1 bg-green-100 dark:bg-green-900 text-green-800 dark:text-green-200 text-xs rounded border border-green-300 dark:border-green-700">
                  ðŸ“¹ Body Cam
                </span>
              )}
            </div>

            <a 
              href={`/cases/${caseItem.slug}`}
              class="inline-block text-red-600 dark:text-red-500 hover:text-red-700 dark:hover:text-red-400 text-sm font-medium"
            >
              Read more â†’
            </a>
          </div>
        </article>
      ))}
    </div>
    </div>
  </section>

  <!-- Load search script -->
  <script src="../../scripts/caseSearch.js"></script>
  <script>
    // Dropdown management
    const dropdowns = {
      'location-filter-btn': 'location-filter-dropdown',
      'agency-filter-btn': 'agency-filter-dropdown'
    };

    // Close all dropdowns
    function closeAllDropdowns() {
      Object.values(dropdowns).forEach(id => {
        const dropdown = document.getElementById(id);
        if (dropdown) dropdown.classList.add('hidden');
      });
      Object.keys(dropdowns).forEach(btnId => {
        const btn = document.getElementById(btnId);
        if (btn && !btn.dataset.toggleFilter) {
          btn.classList.remove('border-red-500', 'dark:border-red-400');
        }
      });
    }

    // Toggle dropdown
    Object.keys(dropdowns).forEach(btnId => {
      const btn = document.getElementById(btnId);
      const dropdownId = dropdowns[btnId];
      
      if (btn) {
        btn.addEventListener('click', (e) => {
          e.stopPropagation();
          const dropdown = document.getElementById(dropdownId);
          const isCurrentlyOpen = !dropdown.classList.contains('hidden');
          
          closeAllDropdowns();
          
          if (!isCurrentlyOpen) {
            dropdown.classList.remove('hidden');
            btn.classList.add('border-red-500', 'dark:border-red-400');
          }
        });
      }
    });

    // Body cam toggle button
    const bodycamBtn = document.getElementById('bodycam-filter-btn');
    const bodycamCheckbox = document.getElementById('bodycam-filter');
    
    if (bodycamBtn && bodycamCheckbox) {
      bodycamBtn.addEventListener('click', (e) => {
        e.stopPropagation();
        bodycamCheckbox.checked = !bodycamCheckbox.checked;
        
        if (bodycamCheckbox.checked) {
          bodycamBtn.classList.add('bg-green-100', 'dark:bg-green-900/30', 'border-green-500', 'dark:border-green-400', 'text-green-700', 'dark:text-green-300');
          bodycamBtn.classList.remove('bg-white', 'dark:bg-gray-700', 'border-gray-200', 'dark:border-gray-600', 'text-gray-700', 'dark:text-gray-300');
        } else {
          bodycamBtn.classList.remove('bg-green-100', 'dark:bg-green-900/30', 'border-green-500', 'dark:border-green-400', 'text-green-700', 'dark:text-green-300');
          bodycamBtn.classList.add('bg-white', 'dark:bg-gray-700', 'border-gray-200', 'dark:border-gray-600', 'text-gray-700', 'dark:text-gray-300');
        }
        
        if (typeof applyFilters === 'function') applyFilters();
      });
    }

    // Close dropdowns when clicking outside
    document.addEventListener('click', (e) => {
      if (!e.target.closest('.filter-btn') && !e.target.closest('[id$="-filter-dropdown"]')) {
        closeAllDropdowns();
      }
    });

    // Auto-close dropdowns on selection for radios
    document.querySelectorAll('[name="county-filter"], [name="agency-filter"]').forEach(radio => {
      radio.addEventListener('change', () => {
        setTimeout(() => {
          closeAllDropdowns();
        }, 200);
      });
    });

    // Update active filters display
    function updateActiveFilters() {
      const activeFiltersContainer = document.getElementById('active-filters');
      const clearBtn = document.getElementById('clear-filters');
      if (!activeFiltersContainer) return;

      const activeFilters = [];

      // Check search
      const searchInput = document.getElementById('case-search');
      if (searchInput && searchInput.value) {
        activeFilters.push({ type: 'search', label: `Search: "${searchInput.value}"`, clear: () => searchInput.value = '' });
      }

      // Check county
      const countyRadios = document.querySelectorAll('[name="county-filter"]:checked');
      countyRadios.forEach(radio => {
        activeFilters.push({ type: 'county', label: `${radio.value} County`, clear: () => radio.checked = false });
      });

      // Check agency
      const agencyRadios = document.querySelectorAll('[name="agency-filter"]:checked');
      agencyRadios.forEach(radio => {
        activeFilters.push({ type: 'agency', label: radio.value, clear: () => radio.checked = false });
      });

      // Check bodycam
      const bodycamCheckbox = document.getElementById('bodycam-filter');
      if (bodycamCheckbox && bodycamCheckbox.checked) {
        activeFilters.push({ 
          type: 'bodycam', 
          label: 'Body Cam Available', 
          clear: () => {
            bodycamCheckbox.checked = false;
            const bodycamBtn = document.getElementById('bodycam-filter-btn');
            if (bodycamBtn) {
              bodycamBtn.classList.remove('bg-green-100', 'dark:bg-green-900/30', 'border-green-500', 'dark:border-green-400', 'text-green-700', 'dark:text-green-300');
              bodycamBtn.classList.add('bg-white', 'dark:bg-gray-700', 'border-gray-200', 'dark:border-gray-600', 'text-gray-700', 'dark:text-gray-300');
            }
          }
        });
      }

      // Render active filters
      activeFiltersContainer.innerHTML = activeFilters.map((filter, index) => `
        <button 
          class="active-filter-pill px-3 py-1 bg-red-100 dark:bg-red-900/30 text-red-700 dark:text-red-300 rounded-full text-sm font-medium flex items-center gap-2 hover:bg-red-200 dark:hover:bg-red-900/50 transition-colors"
          data-filter-index="${index}"
        >
          ${filter.label}
          <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
          </svg>
        </button>
      `).join('');

      // Add click handlers to remove individual filters
      document.querySelectorAll('.active-filter-pill').forEach((pill, index) => {
        pill.addEventListener('click', () => {
          activeFilters[index].clear();
          updateActiveFilters();
          if (typeof applyFilters === 'function') applyFilters();
        });
      });

      // Show/hide clear all button
      if (clearBtn) {
        if (activeFilters.length > 0) {
          clearBtn.classList.remove('hidden');
        } else {
          clearBtn.classList.add('hidden');
        }
      }
    }

    // Listen for filter changes
    document.getElementById('case-search')?.addEventListener('input', updateActiveFilters);
    document.querySelectorAll('[name="county-filter"]').forEach(r => r.addEventListener('change', updateActiveFilters));
    document.querySelectorAll('[name="agency-filter"]').forEach(r => r.addEventListener('change', updateActiveFilters));
    document.getElementById('bodycam-filter')?.addEventListener('change', updateActiveFilters);
  </script>
</MainLayout>