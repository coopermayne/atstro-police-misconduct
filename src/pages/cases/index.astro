---
import MainLayout from '../../layouts/MainLayout.astro';
import FilterableCasesList from '../../components/FilterableCasesList';
import { getCollection } from 'astro:content';

// Get all published cases
const cases = await getCollection('cases', ({ data }) => data.published);

// Sort by incident date (most recent first)
const sortedCases = cases.sort((a, b) => 
  new Date(b.data.incident_date).getTime() - new Date(a.data.incident_date).getTime()
);

// Get the most recent case for featured section
const featuredCase = sortedCases[0];
const recentCases = sortedCases.slice(1, 4);
---

<MainLayout content={{ title: 'Cases' }}>
  <!-- Hero Section -->
  <header class="bg-white dark:bg-gray-900 mb-8">
    <div class="container px-6 py-10 mx-auto border-b-4 border-red-600">
      <h1 class="text-3xl font-semibold text-gray-800 dark:text-white lg:text-4xl">
        California <span class="text-red-600">Deadly Force Cases</span>
      </h1>
      <p class="mt-3 text-gray-600 dark:text-gray-400">
        Comprehensive documentation of deadly force incidents across California. Each case includes detailed information, timelines, and investigation status.
      </p>
    </div>
  </header>

  <!-- Recent Cases Section -->
  <section class="bg-white dark:bg-gray-900">
    <div class="container px-6 py-10 mx-auto">
      <h2 class="text-3xl font-bold text-center text-gray-800 dark:text-white mb-8">
        Recent Cases
      </h2>
      
      <div class="lg:flex lg:-mx-6">
        <!-- Most Recent Case (Featured) -->
        {featuredCase && (
          <div class="lg:w-3/4 lg:px-6">
            <div class="bg-gray-100 dark:bg-gray-800 w-full h-80 xl:h-[28rem] rounded-xl flex flex-col items-center justify-center p-8 border-2 border-gray-300 dark:border-gray-600">
              <h3 class="text-4xl font-bold text-gray-800 dark:text-white mb-4">{featuredCase.data.victim_name}</h3>
              <p class="text-xl text-gray-600 dark:text-gray-400">{featuredCase.data.city}, {featuredCase.data.county} County</p>
              <p class="text-lg text-gray-600 dark:text-gray-400 mt-2">{new Date(featuredCase.data.incident_date).toLocaleDateString('en-US', { year: 'numeric', month: 'long', day: 'numeric' })}</p>
            </div>
            
            <div>
              <p class="mt-6 text-sm text-red-600 uppercase">Most Recent Case</p>
              <h1 class="max-w-lg mt-4 text-2xl font-semibold leading-tight text-gray-800 dark:text-white">
                {featuredCase.data.title}
              </h1>
              <div class="mt-4 space-y-2 text-sm text-gray-600 dark:text-gray-400">
                <p><strong class="text-gray-800 dark:text-gray-300">Victim:</strong> {featuredCase.data.victim_name}</p>
                {featuredCase.data.age && <p><strong class="text-gray-800 dark:text-gray-300">Age:</strong> {featuredCase.data.age}</p>}
                <p><strong class="text-gray-800 dark:text-gray-300">Location:</strong> {featuredCase.data.city}, {featuredCase.data.county} County</p>
              </div>
              
              <!-- Agencies -->
              <div class="flex flex-wrap gap-2 mt-4">
                {featuredCase.data.agencies.slice(0, 3).map(agency => (
                  <span class="px-3 py-1 bg-gray-100 dark:bg-gray-700 text-gray-700 dark:text-gray-300 text-xs rounded border border-gray-300 dark:border-gray-600">
                    {agency}
                  </span>
                ))}
              </div>
              
              <a 
                href={`/cases/${featuredCase.slug}`} 
                class="inline-block mt-4 text-red-600 hover:underline"
              >
                Read Full Case â†’
              </a>
            </div>
          </div>
        )}

        <!-- Other Recent Cases (Sidebar) -->
        <div class="mt-8 lg:w-1/4 lg:mt-0 lg:px-6">
          {recentCases.map((caseItem, index) => (
            <div>
              <h3 class="text-red-600 capitalize">Recent Case</h3>
              <a 
                href={`/cases/${caseItem.slug}`} 
                class="block mt-2 font-medium text-gray-700 hover:underline hover:text-gray-500 dark:text-gray-400"
              >
                {caseItem.data.victim_name}
              </a>
              <p class="text-sm text-gray-600 dark:text-gray-400 mt-1">
                {caseItem.data.city}, {caseItem.data.county} County
              </p>
              <p class="text-sm text-gray-600 dark:text-gray-400 mt-1">
                {new Date(caseItem.data.incident_date).toLocaleDateString('en-US', { month: 'numeric', day: 'numeric', year: 'numeric' })}
              </p>
              {index < recentCases.length - 1 && (
                <hr class="my-6 border-gray-200 dark:border-gray-700" />
              )}
            </div>
          ))}
        </div>
      </div>
    </div>
  </section>

  <!-- All Cases with Search and Filters -->
  <section class="px-6 pb-10 mt-10">
    <h2 class="text-2xl font-bold text-gray-800 dark:text-white mb-6">Search and Browse All Cases</h2>
    <FilterableCasesList client:load cases={sortedCases} />
  </section>
</MainLayout>