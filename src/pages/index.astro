---
import MainLayout from '../layouts/MainLayout.astro';
import ArticleGrid from '../components/ArticleGrid.astro';
import { getCollection } from 'astro:content';

// Get recent cases
const cases = await getCollection('cases', ({ data }) => data.published);
const sortedCases = cases.sort((a, b) => 
  new Date(b.data.incident_date).getTime() - new Date(a.data.incident_date).getTime()
).slice(0, 3);

// Get recent posts
const posts = await getCollection('posts', ({ data }) => data.published);
const sortedPosts = posts.sort((a, b) => 
  new Date(b.data.published_date).getTime() - new Date(a.data.published_date).getTime()
).slice(0, 3);

// Get all unique counties and agencies
const allCases = await getCollection('cases', ({ data }) => data.published);
const counties = [...new Set(allCases.map(c => c.data.county))].sort();
const agencies = [...new Set(allCases.flatMap(c => c.data.agencies))].sort();

// Helper function to create slug
function createSlug(name: string): string {
  return name.toLowerCase().trim().replace(/\s+/g, '-');
}
---

<MainLayout content={{ title: 'Home' }}>
  <!-- Hero Section -->
  <header class="bg-white dark:bg-gray-900">
    <div class="container px-6 py-8 mx-auto border-b-4 border-red-600">
      <div class="items-center lg:flex">
      <div class="w-full lg:w-1/2">
        <div class="lg:max-w-lg">
        <h1 class="text-3xl font-semibold text-gray-800 dark:text-white lg:text-4xl">
          Stay Informed on <span class="text-red-600">Police Misconduct</span>
        </h1>
        <p class="mt-3 text-gray-600 dark:text-gray-400">
          Our mission is to provide the latest updates on police misconduct law and share case profiles of individuals affected by police violence in California. Subscribe to our newsletter to stay informed.
        </p>
        <div class="flex flex-col mt-6 space-y-3 lg:space-y-0 lg:flex-row">
          <input id="email" type="text" class="px-4 py-2 text-gray-700 bg-white border rounded-md dark:bg-gray-800 dark:text-gray-300 dark:border-gray-600 focus:border-red-400 dark:focus:border-red-300 focus:outline-none focus:ring focus:ring-opacity-40 focus:ring-red-300" placeholder="Email Address">
          <button class="w-full px-5 py-2 text-sm tracking-wider text-white uppercase transition-colors duration-300 transform bg-red-600 rounded-lg lg:w-auto lg:mx-4 hover:bg-red-500 focus:outline-none focus:bg-red-500">
          Subscribe
          </button>
        </div>
        </div>
      </div>
      <div class="flex items-center justify-center w-full mt-6 lg:mt-0 lg:w-1/2">
        <img class="w-full h-full max-w-md" src="/images/justice-illustration.png" alt="Justice illustration">
      </div>
      </div>
    </div>
  </header>

  <!-- Recent Cases Section -->
  <section class="bg-gray-50 dark:bg-gray-800 px-6 py-8">
    <div class="container mx-auto">
      <div class="flex items-center justify-between mb-4">
        <h2 class="text-2xl font-bold text-gray-800 dark:text-white">Recent Cases</h2>
        <a href="/cases" class="text-red-600 dark:text-red-500 hover:underline font-medium">View all →</a>
      </div>
      
      <ArticleGrid items={sortedCases} type="case" />
    </div>
  </section>

  <!-- Recent Blog Posts Section -->
  <section class="bg-white dark:bg-gray-900 px-6 py-8">
    <div class="container mx-auto">
      <div class="flex items-center justify-between mb-4">
        <h2 class="text-2xl font-bold text-gray-800 dark:text-white">Recent Blog Posts</h2>
        <a href="/posts" class="text-red-600 dark:text-red-500 hover:underline font-medium">View all →</a>
      </div>
      
      <ArticleGrid items={sortedPosts} type="post" />
    </div>
  </section>

  <!-- Browse by Location/Agency Section -->
  <section class="bg-white dark:bg-gray-900 px-6 py-8">
    <div class="container mx-auto">
      <h2 class="text-2xl font-bold text-gray-800 dark:text-white mb-4 text-center">
        Browse by Location or Agency
      </h2>
      <p class="text-center text-gray-600 dark:text-gray-400 mb-6">
        Find cases specific to your county or law enforcement agency
      </p>
      
      <div class="grid md:grid-cols-2 gap-8 max-w-4xl mx-auto">
        <!-- Counties -->
        <div class="bg-gray-50 dark:bg-gray-800 rounded-lg p-6 border border-gray-200 dark:border-gray-700">
          <h3 class="text-lg font-semibold text-gray-800 dark:text-white mb-4">By County</h3>
          <div class="space-y-2 max-h-64 overflow-y-auto">
            {counties.map(county => (
              <a 
                href={`/counties/${createSlug(county)}`}
                class="block px-4 py-2 bg-white dark:bg-gray-700 text-gray-700 dark:text-gray-300 rounded hover:bg-red-50 dark:hover:bg-gray-600 hover:text-red-600 dark:hover:text-red-500 transition-colors border border-gray-200 dark:border-gray-600"
              >
                {county} County
              </a>
            ))}
          </div>
        </div>

        <!-- Agencies -->
        <div class="bg-gray-50 dark:bg-gray-800 rounded-lg p-6 border border-gray-200 dark:border-gray-700">
          <h3 class="text-lg font-semibold text-gray-800 dark:text-white mb-4">By Agency</h3>
          <div class="space-y-2 max-h-64 overflow-y-auto">
            {agencies.map(agency => (
              <a 
                href={`/agencies/${createSlug(agency)}`}
                class="block px-4 py-2 bg-white dark:bg-gray-700 text-gray-700 dark:text-gray-300 rounded hover:bg-red-50 dark:hover:bg-gray-600 hover:text-red-600 dark:hover:text-red-500 transition-colors border border-gray-200 dark:border-gray-600"
              >
                {agency}
              </a>
            ))}
          </div>
        </div>
      </div>
    </div>
  </section>

</MainLayout>
