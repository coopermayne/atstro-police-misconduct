---
import MainLayout from '../../../layouts/MainLayout.astro';
import { getCollection } from 'astro:content';

export async function getStaticPaths() {
  // Helper function to create slug from text
  function createSlug(name: string): string {
    return name.toLowerCase().trim().replace(/\s+/g, '-');
  }
  
  const posts = await getCollection('posts', ({ data }) => data.published);
  
  // Get all unique tags
  const allTags = [...new Set(posts.flatMap(post => post.data.tags))];
  
  // Create paths for each tag
  return allTags.map(tag => {
    const tagSlug = createSlug(tag);
    const taggedPosts = posts.filter(post => 
      post.data.tags.some(t => createSlug(t) === tagSlug)
    );
    
    return {
      params: { tag: tagSlug },
      props: { tag, posts: taggedPosts },
    };
  });
}

const { tag, posts } = Astro.props;

// Sort posts by date (most recent first)
const sortedPosts = posts.sort((a, b) => 
  new Date(b.data.published_date).getTime() - new Date(a.data.published_date).getTime()
);

// Get all tags for sidebar
const allPosts = await getCollection('posts', ({ data }) => data.published);
const allTags = [...new Set(allPosts.flatMap(p => p.data.tags))];

// Helper to get featured image URL
function getFeaturedImageUrl(featuredImage: {imageId: string, alt: string, caption?: string} | undefined): string | undefined {
  if (!featuredImage?.imageId) return undefined;
  const accountHash = "3oZsG34qPq3SIXQhl47vqA";
  return `https://imagedelivery.net/${accountHash}/${featuredImage.imageId}/medium`;
}

// Create tagSlug for template use
const tagSlug = tag.toLowerCase().trim().replace(/\s+/g, '-');
---

<MainLayout content={{ title: `${tag} Articles` }}>
  <!-- Breadcrumb -->
  <nav class="px-6 pt-8 text-sm text-gray-600 dark:text-gray-400 mb-6">
    <a href="/" class="hover:text-red-600 dark:hover:text-red-500">Home</a>
    <span class="mx-2">/</span>
    <a href="/posts" class="hover:text-red-600 dark:hover:text-red-500">Blog</a>
    <span class="mx-2">/</span>
    <span class="text-gray-800 dark:text-gray-300">Tags</span>
    <span class="mx-2">/</span>
    <span class="text-gray-800 dark:text-gray-300">{tag}</span>
  </nav>

  <!-- Header -->
  <header class="bg-white dark:bg-gray-900 mb-8 px-6">
    <div class="container py-10 mx-auto border-b-4 border-red-600">
      <h1 class="text-3xl font-semibold text-gray-800 dark:text-white lg:text-4xl">
        Articles tagged: <span class="text-red-600">{tag}</span>
      </h1>
      <p class="mt-3 text-gray-600 dark:text-gray-400">
        Showing {sortedPosts.length} {sortedPosts.length === 1 ? 'article' : 'articles'} about {tag}
      </p>
    </div>
  </header>

  <div class="px-6 pb-10">
    <div class="lg:flex lg:gap-8">
      <!-- Main Content - Posts -->
      <div class="lg:w-3/4">
        <div class="grid gap-6 md:grid-cols-2">
          {sortedPosts.map(post => (
            <article class="bg-white dark:bg-gray-800 rounded-lg shadow-md hover:shadow-lg transition-shadow border border-gray-200 dark:border-gray-700">
              {post.data.featured_image ? (
                <img 
                  src={getFeaturedImageUrl(post.data.featured_image)} 
                  alt={post.data.title}
                  class="w-full h-48 object-cover rounded-t-lg"
                />
              ) : (
                <div class="w-full h-48 bg-gray-200 dark:bg-gray-700 rounded-t-lg flex items-center justify-center">
                  <span class="text-gray-400 dark:text-gray-500">No image</span>
                </div>
              )}
              
              <div class="p-6">
                <h2 class="text-xl font-semibold text-gray-800 dark:text-white mb-3">
                  <a href={`/posts/${post.slug}`} class="hover:text-red-600 dark:hover:text-red-500">
                    {post.data.title}
                  </a>
                </h2>
                
                <p class="text-sm text-gray-600 dark:text-gray-400 mb-4">
                  {post.data.description}
                </p>

                <p class="text-xs text-gray-500 dark:text-gray-500 mb-3">
                  {new Date(post.data.published_date).toLocaleDateString('en-US', { year: 'numeric', month: 'long', day: 'numeric' })}
                </p>

                <div class="flex flex-wrap gap-2 mb-4">
                  {post.data.tags.map(postTag => {
                    const postTagSlug = postTag.toLowerCase().trim().replace(/\s+/g, '-');
                    return (
                      <a
                        href={`/posts/tags/${postTagSlug}`}
                        class={`px-2 py-1 text-xs rounded ${
                          postTagSlug === tagSlug
                            ? 'bg-red-600 text-white'
                            : 'bg-red-100 dark:bg-red-900 text-red-800 dark:text-red-200 hover:bg-red-200 dark:hover:bg-red-800'
                        }`}
                      >
                        {postTag}
                      </a>
                    );
                  })}
                </div>

                <a 
                  href={`/posts/${post.slug}`}
                  class="inline-block text-red-600 dark:text-red-500 hover:text-red-700 dark:hover:text-red-400 text-sm font-medium"
                >
                  Read full article →
                </a>
              </div>
            </article>
          ))}
        </div>
      </div>

      <!-- Sidebar - All Tags -->
      <aside class="mt-8 lg:mt-0 lg:w-1/4">
        <div class="bg-white dark:bg-gray-800 rounded-lg shadow-md border border-gray-200 dark:border-gray-700 p-6 sticky top-4">
          <h3 class="text-lg font-semibold text-gray-800 dark:text-white mb-4">
            Browse All Topics
          </h3>
          <div class="flex flex-col gap-2">
            {allTags.sort().map(t => {
              const tSlug = t.toLowerCase().trim().replace(/\s+/g, '-');
              return (
                <a 
                  href={`/posts/tags/${tSlug}`}
                  class={`px-3 py-2 rounded text-sm transition-colors ${
                    tSlug === tagSlug
                      ? 'bg-red-600 text-white'
                      : 'bg-gray-100 dark:bg-gray-700 text-gray-700 dark:text-gray-300 hover:bg-red-100 dark:hover:bg-gray-600'
                  }`}
                >
                  {t}
                </a>
              );
            })}
          </div>
          
          <div class="mt-6 pt-6 border-t border-gray-200 dark:border-gray-700">
            <a 
              href="/posts"
              class="text-red-600 dark:text-red-500 hover:underline text-sm font-medium"
            >
              ← View all posts
            </a>
          </div>
        </div>
      </aside>
    </div>
  </div>
</MainLayout>
